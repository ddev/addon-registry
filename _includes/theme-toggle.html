<button
    id="theme-toggle"
    type="button"
    class="theme-toggle"
    aria-label="Toggle theme"
    title="Switch to light mode"
>
    <!-- Auto icon (sun with split center) -->
    <svg
        id="theme-icon-auto"
        class="theme-icon"
        style="display: none"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
    >
        <path
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636"
        />
        <circle cx="12" cy="12" r="3.75" fill="currentColor" opacity="0.3" />
        <path d="M12 8.25A3.75 3.75 0 0 1 12 15.75Z" fill="currentColor" />
    </svg>
    <!-- Light mode icon (sun) -->
    <svg
        id="theme-icon-light"
        class="theme-icon"
        style="display: none"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
    >
        <path
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z"
        />
    </svg>
    <!-- Dark mode icon (moon) -->
    <svg
        id="theme-icon-dark"
        class="theme-icon"
        style="display: none"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
    >
        <path
            stroke="currentColor"
            stroke-width="1.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z"
        />
    </svg>
</button>

<script>
    // Immediately show the correct icon based on saved theme
    (function() {
        const savedTheme = typeof localStorage !== 'undefined' ? localStorage.getItem('theme') : null;
        const currentTheme = savedTheme || 'auto';

        const autoIcon = document.getElementById('theme-icon-auto');
        const lightIcon = document.getElementById('theme-icon-light');
        const darkIcon = document.getElementById('theme-icon-dark');

        if (currentTheme === 'auto' && autoIcon) {
            autoIcon.style.display = 'block';
        } else if (currentTheme === 'light' && lightIcon) {
            lightIcon.style.display = 'block';
        } else if (currentTheme === 'dark' && darkIcon) {
            darkIcon.style.display = 'block';
        }
    })();

    document.addEventListener('DOMContentLoaded', function() {
        const themeToggle = document.getElementById('theme-toggle');
        const autoIcon = document.getElementById('theme-icon-auto');
        const lightIcon = document.getElementById('theme-icon-light');
        const darkIcon = document.getElementById('theme-icon-dark');

        // Get current theme or default to auto
        let currentTheme = localStorage.getItem('theme') || 'auto';

        const updateTitle = function(currentTheme) {
            if (!themeToggle) return;
            // Switch to opposite of current system preference
            const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            // Show what the NEXT theme will be when clicked
            if (currentTheme === 'auto') {
                themeToggle.title = systemDark ? 'Switch to light mode' : 'Switch to dark mode';
            } else if (currentTheme === 'light') {
                themeToggle.title = systemDark ? 'Switch to dark mode' : 'Switch to system preference';
            } else {
                themeToggle.title = systemDark ? 'Switch to system preference' : 'Switch to light mode';
            }
        };

        const updateGiscusTheme = function(theme) {
            const iframe = document.querySelector('iframe.giscus-frame');
            if (!iframe) return;

            iframe.contentWindow.postMessage({
                giscus: {
                    setConfig: {
                        theme: theme
                    }
                }
            }, 'https://giscus.app');
        };

        const applyTheme = function(theme) {
            const element = document.documentElement;

            // Hide all icons
            if (autoIcon) autoIcon.style.display = 'none';
            if (lightIcon) lightIcon.style.display = 'none';
            if (darkIcon) darkIcon.style.display = 'none';

            if (theme === 'auto') {
                // Use system preference
                const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (systemDark) {
                    element.setAttribute('data-theme', 'dark');
                    updateGiscusTheme('dark_dimmed');
                } else {
                    element.setAttribute('data-theme', 'light');
                    updateGiscusTheme('light');
                }
                if (autoIcon) autoIcon.style.display = 'block';
                localStorage.removeItem('theme');
            } else if (theme === 'light') {
                element.setAttribute('data-theme', 'light');
                if (lightIcon) lightIcon.style.display = 'block';
                localStorage.setItem('theme', 'light');
                updateGiscusTheme('light');
            } else if (theme === 'dark') {
                element.setAttribute('data-theme', 'dark');
                if (darkIcon) darkIcon.style.display = 'block';
                localStorage.setItem('theme', 'dark');
                updateGiscusTheme('dark_dimmed');
            }

            updateTitle(theme);
        };

        // Apply initial theme
        applyTheme(currentTheme);

        // Listen for system theme changes when in auto mode
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        mediaQuery.addEventListener('change', function(e) {
            // Only auto-update if in auto mode
            if (currentTheme === 'auto') {
                const element = document.documentElement;
                if (e.matches) {
                    element.setAttribute('data-theme', 'dark');
                } else {
                    element.setAttribute('data-theme', 'light');
                }
            }
        });

        if (themeToggle) {
            themeToggle.addEventListener('click', function() {
                const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                // Cycle through themes intelligently
                if (currentTheme === 'auto') {
                    currentTheme = systemDark ? 'light' : 'dark';
                } else if (currentTheme === 'light') {
                    currentTheme = systemDark ? 'dark' : 'auto';
                } else {
                    currentTheme = systemDark ? 'auto' : 'light';
                }

                applyTheme(currentTheme);
            });
        }

        // Listen for Giscus to load
        window.addEventListener('message', function(event) {
            if (event.origin !== 'https://giscus.app') return;
            if (!(typeof event.data === 'object' && event.data.giscus)) return;

            // When Giscus is ready, set the initial theme
            const savedTheme = localStorage.getItem('theme') || 'auto';
            if (savedTheme === 'light') {
                updateGiscusTheme('light');
            } else if (savedTheme === 'dark' || (savedTheme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                updateGiscusTheme('dark_dimmed');
            }
        });
    });
</script>